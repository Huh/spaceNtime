print(ov)
return(ov)
stop("There are overlapping time intervals in deploy")
} else{
return(deploy)
}
}
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2015-12-18 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 150, 450)
)
validate_deploy(deploy)
validate_deploy <- function(deploy){
deploy %>%
verify(has_all_names("cam", "start", "end", "area")) %>%
# Check class of all columns
verify(is.numeric(area)) %>%
verify(area >= 0) %>%
# Check start and end
validate_start_end(.)
# Make sure rows non-overlapping
ov <- find_overlap(deploy)
if(nrow(ov) != 0){
return(ov)
stop("There are overlapping time intervals in deploy")
} else{
return(deploy)
}
}
validate_deploy(deploy)
validate_deploy <- function(deploy){
deploy %>%
verify(has_all_names("cam", "start", "end", "area")) %>%
# Check class of all columns
verify(is.numeric(area)) %>%
verify(area >= 0) %>%
# Check start and end
validate_start_end(.)
# Make sure rows non-overlapping
ov <- find_overlap(deploy)
if(nrow(ov) != 0){
print(ov)
stop("There are overlapping time intervals in deploy")
} else{
return(deploy)
}
}
validate_deploy(deploy)
devtools::load_all(".")
?validate_df
package?dplyr
validate_df
usethis::use_r("build_occ.R")
dplyr::left_join
# Date the user needs to feed in
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 2, 1, 2)
)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2016-01-01 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 200, 450)
)
devtools::load_all(".")
validate_start_end(deploy)
devtools::load_all(".")
devtools::load_all(".")
validate_df(df)
validate_df_deploy(df, deploy)
validate_occ(occ)
study_dates <- as.POSIXct(c("2016-01-01 00:00:00", "2016-01-04 23:59:59"), tz = "GMT")
occ <- build_occ(samp_freq = 3600,
samp_length = 10,
study_start = study_dates[1],
study_end = study_dates[2])
occ
usethis::use_r("effort_fn.R")
dd <- list(df = df,
deploy = deploy,
occ = occ)
dd
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., chck_names, add_int)
usethis::use_r("add_int.R")
#' Add interval column
#'
#' @param x a dataframe or tibble with columns "start" and "end"
#'
#' @return a dataframe or tibble
#' @export
#'
#' @examples add_int(deploy)
add_int <- function(x){
x %>%
mutate(int = start %--% end)
}
#' Add interval column
#'
#' @param x a dataframe or tibble with columns "start" and "end"
#'
#' @return a dataframe or tibble
#' @export
#'
#' @examples add_int(deploy)
add_int <- function(x){
x %>%
mutate(int = lubridate::interval(start, end) )
}
add_int(deploy)
c("start", "end") %in% names(deploy)
colnames <- c("start","end")
colnames %in% names(deploy)
all(colnames %in% names(deploy))
usethis::use_r("chck_names")
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., chck_names, add_int)
#'
#' This isn't different from verify, but it's used in map_if in effort_fn
#'
#' @param x a dataframe
#' @param colnames a character vector of column names you want to check exist
#'
#' @return
#' @export
#'
#' @examples
chck_names <- function(x, colnames){
all(colnames %in% names(x))
}
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., chck_names(., c("start", "end")), add_int)
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., ~chck_names(., c("start", "end")), add_int)
dd
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., ~assertr::verify(has_all_names("start", "end")), add_int)
# Create intervals in data
dd <- list(df = df,
deploy = deploy,
occ = occ) %>%
purrr::map_if(., assertr::verify(has_all_names("start", "end")), add_int)
chck_names(occ, c("start", "end))
chck_names(occ, c("start", "end"))
dd
# Create intervals in data
dd <- list(deploy = deploy,
occ = occ) %>%
purrr::map(., add_int)
dd
purrr::map(c(deploy, occ), add_int)
purrr::map(list(deploy, occ), add_int)
# Create intervals in data
dd <- list(deploy = deploy,
occ = occ) %>%
purrr::map(., add_int)
# Create occasions by camera
effort <- build_occ_cam(df, dd$occ, "effort")
# Create occasions by camera
effort <- build_occ_cam(df, dd$occ)
effort
# Combine occ-by-cam and deploy to get area-by-occ-by-cam
effort <- occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam") %>%
filter(occ_int %within% int) %>%
select(occ, cam, area) %>%
left_join(effort, ., by = c("occ", "cam")) %>%
mutate(area = replace(area, is.na(area), 0))
# Create occasions by camera
occ_by_cam <- build_occ_cam(df, dd$occ)
# Combine occ-by-cam and deploy to get area-by-occ-by-cam
effort <- occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam") %>%
filter(occ_int %within% int) %>%
select(occ, cam, area) %>%
left_join(effort, ., by = c("occ", "cam")) %>%
mutate(area = replace(area, is.na(area), 0))
lubridate::%within%
lubridate::`%within%``
lubridate::`%within%`
lubridate::`%within%`
# Combine occ-by-cam and deploy to get area-by-occ-by-cam
effort <- occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam") %>%
filter(occ_int %within% int) %>%
select(occ, cam, area) %>%
left_join(effort, ., by = c("occ", "cam")) %>%
mutate(area = replace(area, is.na(area), 0))
# Create intervals in data
deploy %>%
add_int(.)
# Create intervals in data
dd <- list(deploy = deploy,
occ = occ) %>%
purrr::map(., add_int)
# Create occasions by camera
occ_by_cam <- build_occ_cam(deploy, dd$occ)
occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam")
occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam") %>%
filter(occ_int %within% int) %>%
select(occ, cam, area) %>%
left_join(occ_by_cam, ., by = c("occ", "cam"))
library(lubridate)
occ_by_cam %>%
rename(occ_int = int) %>%
left_join(., dd$deploy, by = "cam") %>%
filter(occ_int %within% int) %>%
select(occ, cam, area) %>%
left_join(occ_by_cam, ., by = c("occ", "cam"))
# Create intervals in deploy
deploy %>%
add_int(.)
occ
deploy
# Create occasions by camera
occ_by_cam <- build_occ_cam(deploy, occ)
occ_by_cam
occ_by_cam %>%
rename(occ_int = int)
devtools::load_all(".")
effort_fn(df, deploy, occ)
effort_fn(df, deploy, occ)%>%filter(area)
effort_fn(df, deploy, occ)%>%select(area)
effort_fn(df, deploy, occ)%>%select(area) %>%print(n=Inf)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2015-12-18 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 150, 450)
)
effort_fn(df, deploy, occ)
# Date the user needs to feed in
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 2, 1, 2)
)
usethis::use_r("calc_censor")
usethis::use_r("calc_ste")
?duplicated
devtools::load_all(".")
calc_ste(df, occ, effort)
calc_ste(df, occ, eff)
eff <- effort_fn(deploy, occ)
eff
calc_ste(df, occ, eff)
usethis::use_r("build_ste_EH")
usethis::use_r("build_ste_eh.R")
devtools::load_all(".")
?build_ste_eh
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 2, 1, 2)
)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2016-01-01 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 200, 450)
)
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
occ <- build_occ(samp_freq = 3600,
samp_length = 10,
study_start = study_dates[1],
study_end = study_dates[2])
study_dates <- as.POSIXct(c("2016-01-01 00:00:00", "2016-01-04 23:59:59"), tz = "GMT")
occ <- build_occ(samp_freq = 3600,
samp_length = 10,
study_start = study_dates[1],
study_end = study_dates[2])
build_ste_eh(df, deploy, occ, study_area = 1e6)
devtools::load_all(".")
build_ste_eh(df, deploy, occ, study_area = 1e6)
devtools::load_all(".")
build_ste_eh(df, deploy, occ, study_area = 1e6)
devtools::load_all(".")
build_ste_eh(df, deploy, occ, study_area = 1e6)
ste_eh <- build_ste_eh(df, deploy, occ, study_area = 1e6)
calc_ste(df, occ, eff)
eff <- effort_fn(deploy, occ)
eff <- effort_fn(deploy, occ)
calc_ste(df, occ, eff)
devtools::load_all(".")
calc_ste(df, occ, eff)
ste_eh <- build_ste_eh(df, deploy, occ, study_area = 1e6)
ste_eh
ste_estN_fn(ste_eh)
devtools::load_all(".")
ste_eh <- build_ste_eh(df, deploy, occ, study_area = 1e6)
ste_estN_fn(ste_eh)
devtools::load_all(".")
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 0, 1, 2)
)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2016-01-01 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 200, 450)
)
study_dates <- as.POSIXct(c("2016-01-01 00:00:00", "2016-01-04 23:59:59"), tz = "GMT")
occ <- build_occ(samp_freq = 3600,
samp_length = 10,
study_start = study_dates[1],
study_end = study_dates[2])
ste_eh <- build_ste_eh(df, deploy, occ, study_area = 1e6)
ste_eh
ste_estN_fn(ste_eh)
# Build effort for each cam at each occasion
eff <- effort_fn(deploy, occ)
eff
occ
# Calculate the censors
censor <- calc_censor(eff)
# Calculate STE at each occasion
tmp <- calc_ste(df, occ, eff)
tmp
head(tmp)
?optim
devtools::load_all(".")
ste_estN_fn(ste_eh)
devtools::load_all(".")
ste_estN_fn(ste_eh)
ste_eh
tmp
# Calculate STE at each occasion
tmp <- calc_ste(df, occ, eff)   %>%
mutate(censor = censor)
# Calculate STE at each occasion
tmp <- calc_ste(df, occ, eff)   %>%
mutate(censor = censor$censor)
head(tmp)
x<-tmp
dat <- list(toevent = matrix(x$STE, nrow = 1),
censor = x$censor,
A = study_area )
dat <- list(toevent = matrix(x$STE, nrow = 1),
censor = x$censor,
A = 1e6)
dat
dat <- list(toevent = matrix(x$STE, nrow = 1),
censor = x$censor,
A = study_area )
dat <- list(toevent = matrix(x$STE, nrow = 1),
censor = x$censor,
A = 1e6)
dat
opt <- suppressWarnings(
stats::optim(log(1/mean(dat$toevent, na.rm = T)),
exp_logl_fn,
x = dat,
control = list(fnscale = -1),
hessian = T)
)
dat <- list(toevent = matrix(x$STE, nrow = 1),
censor = x$censor)
opt <- suppressWarnings(
stats::optim(log(1/mean(dat$toevent, na.rm = T)),
exp_logl_fn,
x = dat,
control = list(fnscale = -1),
hessian = T)
)
# Estimate of lambda
estlam <- exp(opt$par)
# estlam is average density per m2
estN <- estlam * study_area
devtools::load_all(".")
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 0, 1, 2)
)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2016-01-01 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 200, 450)
)
study_dates <- as.POSIXct(c("2016-01-01 00:00:00", "2016-01-04 23:59:59"), tz = "GMT")
occ <- build_occ(samp_freq = 3600,
samp_length = 10,
study_start = study_dates[1],
study_end = study_dates[2])
ste_eh <- build_ste_eh(df, deploy, occ, study_area = 1e6)
ste_eh <- build_ste_eh(df, deploy, occ)
ste_eh
ste_eh
ste_estN_fn(ste_eh, study_area = 1e6)
calc_ste(df, occ, eff)
# Build effort for each cam at each occasion
eff <- effort_fn(deploy, occ)
out <- calc_ste(df, occ, eff)
head(out)
head(df)
head(occ)
dim(out)
dim(occ)
devtools::install_github("annam21/TTE.STE.IS/tree/version-2", build_opts = c("--no-resave-data", "--no-manual"), force = T)
